{{define "swap_form"}}
<div class="swap-card fade-in">
    <!-- Card Header -->
    <div style="margin-bottom: 24px;">
        <h2 style="font-size: 24px; font-weight: 700; margin-bottom: 8px;">Swap Crypto</h2>
        <p style="color: #64748b; font-size: 14px;">Best rates from {{.ExchangeCount}} exchanges. No KYC. Private & Secure.</p>
    </div>
    
    <!-- Swap Form -->
    <form id="swapForm">
        <!-- From Section -->
        <div class="input-section">
            <label style="color: #64748b; font-size: 12px; display: block; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.05em;">You Send</label>
            <div style="display: flex; align-items: center; justify-content: space-between; gap: 16px;">
                <input type="number" 
                       name="amount"
                       placeholder="0.0"
                       step="any"
                       style="background: transparent; border: none; color: white; font-size: 28px; font-weight: 600; flex: 1; outline: none; min-width: 0;"
                       id="fromAmount"
                       hx-post="/htmx/quote"
                       hx-trigger="keyup changed delay:500ms"
                       hx-target="#rate-info"
                       hx-include="[name='from'],[name='to']">
                
                <div style="position: relative; flex-shrink: 0;">
                    <input type="hidden" name="from" id="fromValue" value="btc">
                    
                    <!-- Botón para abrir dropdown -->
                    <div class="token-button" onclick="toggleDropdown('from')" style="cursor: pointer;">
                        <div class="token-icon">
                            <span id="fromTokenIcon">BTC</span>
                        </div>
                        <span id="fromTokenLabel">Bitcoin</span>
                        <svg style="width: 16px; height: 16px; flex-shrink: 0;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                        </svg>
                    </div>
                    
                    <!-- Dropdown con búsqueda -->
                    <div id="fromDropdown" class="currency-dropdown" style="display: none; position: absolute; top: 100%; right: 0; margin-top: 8px; background: rgba(15, 23, 42, 0.98); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5); z-index: 1000; width: 250px;">
                        <div class="currency-search-box">
                            <input type="text" 
                                   placeholder="Search currency..."
                                   class="currency-search-input"
                                   oninput="searchCurrencies('from', this.value)">
                        </div>
                        <div class="currency-list">
                            <select id="fromSelectHidden" 
                                    class="currency-select" 
                                    size="10" 
                                    onchange="selectCurrency('from', this)">
                                <!-- Opciones se cargan aquí -->
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Swap Button -->
        <div class="swap-button" onclick="swapPairs()">
            <svg style="width: 24px; height: 24px; color: #94a3b8;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"/>
            </svg>
        </div>
        
        <!-- To Section -->
        <div class="input-section">
            <label style="color: #64748b; font-size: 12px; display: block; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.05em;">You Receive</label>
            <div style="display: flex; align-items: center; justify-content: space-between; gap: 16px;">
                <input type="number" 
                       name="toAmount"
                       placeholder="0.0"
                       readonly
                       style="background: transparent; border: none; color: white; font-size: 28px; font-weight: 600; flex: 1; outline: none; opacity: 0.7; min-width: 0;"
                       id="toAmount">
                
                <div style="position: relative; flex-shrink: 0;">
                    <input type="hidden" name="to" id="toValue" value="eth">
                    
                    <!-- Botón para abrir dropdown -->
                    <div class="token-button" onclick="toggleDropdown('to')" style="cursor: pointer;">
                        <div class="token-icon" style="background: linear-gradient(135deg, #ec4899 0%, #8b5cf6 100%);">
                            <span id="toTokenIcon">ETH</span>
                        </div>
                        <span id="toTokenLabel">Ethereum</span>
                        <svg style="width: 16px; height: 16px; flex-shrink: 0;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                        </svg>
                    </div>
                    
                    <!-- Dropdown con búsqueda -->
                    <div id="toDropdown" class="currency-dropdown" style="display: none; position: absolute; top: 100%; right: 0; margin-top: 8px; background: rgba(15, 23, 42, 0.98); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5); z-index: 1000; width: 250px;">
                        <div class="currency-search-box">
                            <input type="text" 
                                   placeholder="Search currency..."
                                   class="currency-search-input"
                                   oninput="searchCurrencies('to', this.value)">
                        </div>
                        <div class="currency-list">
                            <select id="toSelectHidden" 
                                    class="currency-select"
                                    size="10" 
                                    onchange="selectCurrency('to', this)">
                                <!-- Opciones se cargan aquí -->
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Wallet Address -->
        <details style="margin: 24px 0;">
            <summary style="cursor: pointer; color: #94a3b8; font-size: 14px; padding: 12px; background: rgba(8, 10, 28, 0.4); border-radius: 12px; display: flex; justify-content: space-between; align-items: center;">
                <span>Receiving Wallet Address</span>
                <svg style="width: 20px; height: 20px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                </svg>
            </summary>
            <input type="text" 
                   name="to_address"
                   id="toAddress"
                   placeholder="Enter your wallet address"
                   style="width: 100%; background: rgba(8, 10, 28, 0.4); border: 1px solid rgba(255, 255, 255, 0.05); border-radius: 12px; padding: 16px; color: white; font-size: 14px; margin-top: 12px; outline: none;"
                   onfocus="this.style.borderColor='rgba(139, 92, 246, 0.4)'"
                   onblur="this.style.borderColor='rgba(255, 255, 255, 0.05)'">
        </details>
        
        <!-- Rate Info -->
        <div id="rate-info" style="margin-bottom: 24px;">
            <!-- Quotes will load here via HTMX -->
        </div>
        
        <!-- Submit Button -->
        <button type="button" 
                class="primary-button"
                id="swapButton"
                onclick="executeSwap()"
                disabled>
            <span>Enter Amount To Preview Swap</span>
            <span class="spinner" style="margin-left: 8px;"></span>
        </button>
        
        <!-- Security Note -->
        <div style="margin-top: 16px; padding: 12px; background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.2); border-radius: 8px;">
            <div style="display: flex; align-items: center; gap: 8px;">
                <svg style="width: 16px; height: 16px; color: #10b981;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                </svg>
                <span style="color: #10b981; font-size: 12px;">No KYC • No Registration • Your Keys, Your Crypto</span>
            </div>
        </div>
    </form>
</div>

<script>
    // Cargar currencies cuando el componente se monta
    document.addEventListener('DOMContentLoaded', function() {
        // Cargar currencies para ambos dropdowns
        htmx.ajax('GET', '/htmx/currencies', {
            target: '#fromSelectHidden',
            swap: 'innerHTML'
        });
        
        htmx.ajax('GET', '/htmx/currencies', {
            target: '#toSelectHidden',
            swap: 'innerHTML'
        });
    });
    
    function toggleDropdown(type) {
        const dropdown = document.getElementById(type + 'Dropdown');
        const isOpen = dropdown.style.display === 'block';
        
        // Cerrar todos los dropdowns
        document.getElementById('fromDropdown').style.display = 'none';
        document.getElementById('toDropdown').style.display = 'none';
        
        if (!isOpen) {
            dropdown.style.display = 'block';
            const searchInput = dropdown.querySelector('.currency-search-input');
            if (searchInput) {
                searchInput.focus();
                searchInput.value = '';
            }
        }
    }
    
    function searchCurrencies(type, query) {
        const select = document.getElementById(type + 'SelectHidden');
        if (!select) return;
        
        if (!query) {
            // Recargar todas las currencies con su estructura original
            htmx.ajax('GET', '/htmx/currencies', {
                target: '#' + type + 'SelectHidden',
                swap: 'innerHTML'
            });
            return;
        }
        
        // Obtener todas las opciones de todos los optgroups
        const optgroups = select.getElementsByTagName('optgroup');
        let allOptions = [];
        
        // Recolectar todas las opciones manteniendo referencia a su grupo
        for (let group of optgroups) {
            const groupLabel = group.label;
            const options = Array.from(group.getElementsByTagName('option'));
            options.forEach(opt => {
                allOptions.push({
                    value: opt.value,
                    text: opt.text,
                    group: groupLabel
                });
            });
        }
        
        // Filtrar
        const lowerQuery = query.toLowerCase();
        const filtered = allOptions.filter(opt => 
            opt.text.toLowerCase().includes(lowerQuery) || 
            opt.value.toLowerCase().includes(lowerQuery)
        );
        
        // Reconstruir manteniendo grupos si hay resultados en múltiples grupos
        const groupedResults = {};
        filtered.forEach(opt => {
            if (!groupedResults[opt.group]) {
                groupedResults[opt.group] = [];
            }
            groupedResults[opt.group].push(opt);
        });
        
        // Crear el HTML
        let html = '';
        for (let groupName in groupedResults) {
            if (groupedResults[groupName].length > 0) {
                html += `<optgroup label="${groupName}">`;
                groupedResults[groupName].forEach(opt => {
                    html += `<option value="${opt.value}">${opt.text}</option>`;
                });
                html += '</optgroup>';
            }
        }
        
        // Si no hay resultados
        if (!html) {
            html = '<option value="" disabled>No currencies found</option>';
        }
        
        select.innerHTML = html;
    }
    
    function selectCurrency(type, selectElement) {
        const selectedOption = selectElement.options[selectElement.selectedIndex];
        if (!selectedOption) return;
        
        const value = selectedOption.value;
        const text = selectedOption.text;
        const parts = text.split(' - ');
        const symbol = parts[0];
        const name = parts[1] ? parts[1].replace(/\([^)]*\)/, '').trim() : text;
        
        document.getElementById(type + 'Value').value = value;
        document.getElementById(type + 'TokenIcon').textContent = symbol;
        document.getElementById(type + 'TokenLabel').textContent = name;
        document.getElementById(type + 'Dropdown').style.display = 'none';
        
        // Trigger quote update
        htmx.trigger('#fromAmount', 'keyup');
    }
    
    function swapPairs() {
        const fromValue = document.getElementById('fromValue').value;
        const fromIcon = document.getElementById('fromTokenIcon').textContent;
        const fromLabel = document.getElementById('fromTokenLabel').textContent;
        
        const toValue = document.getElementById('toValue').value;
        const toIcon = document.getElementById('toTokenIcon').textContent;
        const toLabel = document.getElementById('toTokenLabel').textContent;
        
        document.getElementById('fromValue').value = toValue;
        document.getElementById('fromTokenIcon').textContent = toIcon;
        document.getElementById('fromTokenLabel').textContent = toLabel;
        
        document.getElementById('toValue').value = fromValue;
        document.getElementById('toTokenIcon').textContent = fromIcon;
        document.getElementById('toTokenLabel').textContent = fromLabel;
        
        htmx.trigger('#fromAmount', 'keyup');
    }
    
    // Cerrar dropdown al hacer clic fuera
    document.addEventListener('click', function(e) {
        if (!e.target.closest('[id$="Dropdown"]') && !e.target.closest('.token-button')) {
            document.getElementById('fromDropdown').style.display = 'none';
            document.getElementById('toDropdown').style.display = 'none';
        }
    });
</script>

{{end}}