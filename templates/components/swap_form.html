{{define "swap_form"}}
<div class="swap-card fade-in">
    <!-- Card Header -->
    <div style="margin-bottom: 24px;">
        <h2 style="font-size: 24px; font-weight: 700; margin-bottom: 8px;">Swap Crypto</h2>
        <p style="color: #64748b; font-size: 14px;">Best rates from {{.ExchangeCount}} exchanges. No KYC. Private & Secure.</p>
    </div>

    <!-- Swap Form -->
    <form id="swapForm">
        <!-- From Section -->
        <div class="input-section">
            <label style="color: #64748b; font-size: 12px; display: block; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.05em;">You Send</label>
            <div style="display: flex; align-items: center; justify-content: space-between; gap: 16px;">
                <input type="number"
                       name="amount"
                       placeholder="0.0"
                       step="any"
                       style="background: transparent; border: none; color: white; font-size: 28px; font-weight: 600; flex: 1; outline: none; min-width: 0;"
                       id="fromAmount"
                       hx-post="/htmx/quote"
                       hx-trigger="keyup changed delay:500ms"
                       hx-target="#rate-info"
                       hx-include="[name='from'],[name='to']">

                <!-- Enhanced Currency Selector for "From" -->
                <div class="currency-selector-container" style="flex-shrink: 0; position: relative;">
                    <div class="token-button"
                         style="flex-shrink: 0; position: relative; cursor: pointer;"
                         onclick="toggleFromDropdown()">
                        <div class="token-icon">
                            <span id="fromTokenIcon">BTC</span>
                        </div>
                        <div class="token-info" style="display: flex; flex-direction: column; align-items: flex-start;">
                            <span id="fromTokenSymbol" style="font-weight: 600; font-size: 14px;">BTC</span>
                            <span id="fromTokenName" style="font-size: 11px; color: #64748b;">Bitcoin</span>
                        </div>
                        <svg style="width: 16px; height: 16px; flex-shrink: 0;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                        </svg>
                    </div>

                    <!-- Hidden select for form submission -->
                    <select name="from" id="fromSelect" style="display: none;">
                        <option value="btc">BTC - Bitcoin</option>
                    </select>

                    <!-- Dropdown Container -->
                    <div id="from-currency-dropdown"
                         style="position: absolute; top: 100%; left: 0; right: 0; z-index: 1000; margin-top: 8px; display: none; min-width: 300px;">
                        <!-- Content will be loaded here via HTMX -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Swap Button -->
        <div class="swap-button" onclick="swapPairs()">
            <svg style="width: 24px; height: 24px; color: #94a3b8;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"/>
            </svg>
        </div>

        <!-- To Section -->
        <div class="input-section">
            <label style="color: #64748b; font-size: 12px; display: block; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.05em;">You Receive</label>
            <div style="display: flex; align-items: center; justify-content: space-between; gap: 16px;">
                <input type="number"
                       name="toAmount"
                       placeholder="0.0"
                       readonly
                       style="background: transparent; border: none; color: white; font-size: 28px; font-weight: 600; flex: 1; outline: none; opacity: 0.7; min-width: 0;"
                       id="toAmount">

                <!-- Enhanced Currency Selector for "To" -->
                <div class="currency-selector-container" style="flex-shrink: 0; position: relative;">
                    <div class="token-button"
                         style="flex-shrink: 0; position: relative; cursor: pointer;"
                         onclick="toggleToDropdown()">
                        <div class="token-icon" style="background: linear-gradient(135deg, #ec4899 0%, #8b5cf6 100%);">
                            <span id="toTokenIcon">ETH</span>
                        </div>
                        <div class="token-info" style="display: flex; flex-direction: column; align-items: flex-start;">
                            <span id="toTokenSymbol" style="font-weight: 600; font-size: 14px;">ETH</span>
                            <span id="toTokenName" style="font-size: 11px; color: #64748b;">Ethereum</span>
                        </div>
                        <svg style="width: 16px; height: 16px; flex-shrink: 0;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                        </svg>
                    </div>

                    <!-- Hidden select for form submission -->
                    <select name="to" id="toSelect" style="display: none;">
                        <option value="eth">ETH - Ethereum</option>
                    </select>

                    <!-- Dropdown Container -->
                    <div id="to-currency-dropdown"
                         style="position: absolute; top: 100%; left: 0; right: 0; z-index: 1000; margin-top: 8px; display: none; min-width: 300px;">
                        <!-- Content will be loaded here via HTMX -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Wallet Address -->
        <details style="margin: 24px 0;">
            <summary style="cursor: pointer; color: #94a3b8; font-size: 14px; padding: 12px; background: rgba(8, 10, 28, 0.4); border-radius: 12px; display: flex; justify-content: space-between; align-items: center;">
                <span>Receiving Wallet Address</span>
                <svg style="width: 20px; height: 20px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                </svg>
            </summary>
            <input type="text"
                   name="to_address"
                   id="toAddress"
                   placeholder="Enter your wallet address"
                   style="width: 100%; background: rgba(8, 10, 28, 0.4); border: 1px solid rgba(255, 255, 255, 0.05); border-radius: 12px; padding: 16px; color: white; font-size: 14px; margin-top: 12px; outline: none;"
                   onfocus="this.style.borderColor='rgba(139, 92, 246, 0.4)'"
                   onblur="this.style.borderColor='rgba(255, 255, 255, 0.05)'">
        </details>

        <!-- Rate Info -->
        <div id="rate-info" style="margin-bottom: 24px;">
            <!-- Quotes will load here via HTMX -->
        </div>

        <!-- Submit Button -->
        <button type="button"
                class="primary-button"
                id="swapButton"
                onclick="executeSwap()"
                disabled>
            <span>Enter Amount To Preview Swap</span>
            <span class="spinner" style="margin-left: 8px;"></span>
        </button>

        <!-- Security Note -->
        <div style="margin-top: 16px; padding: 12px; background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.2); border-radius: 8px;">
            <div style="display: flex; align-items: center; gap: 8px;">
                <svg style="width: 16px; height: 16px; color: #10b981;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                </svg>
                <span style="color: #10b981; font-size: 12px;">No KYC • No Registration • Your Keys, Your Crypto</span>
            </div>
        </div>
    </form>
</div>

<script>
// Function to toggle from dropdown
function toggleFromDropdown() {
    const dropdown = document.getElementById('from-currency-dropdown');
    const toDropdown = document.getElementById('to-currency-dropdown');

    // Hide the other dropdown
    if (toDropdown) {
        toDropdown.style.display = 'none';
    }

    // Toggle current dropdown
    if (dropdown.style.display === 'none' || dropdown.style.display === '') {
        // Load and show dropdown
        htmx.ajax('GET', '/htmx/currencies/selector?target=from', {
            target: '#from-currency-dropdown',
            swap: 'innerHTML'
        }).then(() => {
            dropdown.style.display = 'block';
        });
    } else {
        dropdown.style.display = 'none';
    }
}

// Function to toggle to dropdown
function toggleToDropdown() {
    const dropdown = document.getElementById('to-currency-dropdown');
    const fromDropdown = document.getElementById('from-currency-dropdown');

    // Hide the other dropdown
    if (fromDropdown) {
        fromDropdown.style.display = 'none';
    }

    // Toggle current dropdown
    if (dropdown.style.display === 'none' || dropdown.style.display === '') {
        // Load and show dropdown
        htmx.ajax('GET', '/htmx/currencies/selector?target=to', {
            target: '#to-currency-dropdown',
            swap: 'innerHTML'
        }).then(() => {
            dropdown.style.display = 'block';
        });
    } else {
        dropdown.style.display = 'none';
    }
}

// Function to select a currency (called from the currency options)
function selectCurrency(symbol, displaySymbol, name, target) {
    if (target === 'from') {
        // Update the "from" display
        document.getElementById('fromTokenIcon').textContent = displaySymbol.charAt(0);
        document.getElementById('fromTokenSymbol').textContent = displaySymbol;
        document.getElementById('fromTokenName').textContent = name;

        // Update the hidden select element
        const selectElement = document.getElementById('fromSelect');
        if (selectElement) {
            selectElement.value = symbol;
            // Trigger change event to update quotes
            htmx.trigger('#fromAmount', 'keyup');
        }

        // Hide the dropdown
        const dropdown = document.getElementById('from-currency-dropdown');
        if (dropdown) {
            dropdown.style.display = 'none';
        }
    } else if (target === 'to') {
        // Update the "to" display
        document.getElementById('toTokenIcon').textContent = displaySymbol.charAt(0);
        document.getElementById('toTokenSymbol').textContent = displaySymbol;
        document.getElementById('toTokenName').textContent = name;

        // Update the hidden select element
        const selectElement = document.getElementById('toSelect');
        if (selectElement) {
            selectElement.value = symbol;
            // Trigger change event to update quotes
            htmx.trigger('#fromAmount', 'keyup');
        }

        // Hide the dropdown
        const dropdown = document.getElementById('to-currency-dropdown');
        if (dropdown) {
            dropdown.style.display = 'none';
        }
    }
}

// Close dropdown when clicking outside
document.addEventListener('click', function(event) {
    const container = event.target.closest('.currency-selector-container');
    const fromDropdown = document.getElementById('from-currency-dropdown');
    const toDropdown = document.getElementById('to-currency-dropdown');

    if (!container) {
        if (fromDropdown && fromDropdown.style.display !== 'none') {
            fromDropdown.style.display = 'none';
        }
        if (toDropdown && toDropdown.style.display !== 'none') {
            toDropdown.style.display = 'none';
        }
    }
});

// Load initial currencies when page loads
document.addEventListener('DOMContentLoaded', function() {
    // Set initial values
    document.getElementById('fromSelect').value = 'btc';
    document.getElementById('toSelect').value = 'eth';
});
</script>

{{end}}
